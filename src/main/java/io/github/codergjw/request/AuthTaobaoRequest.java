package io.github.codergjw.request;import io.github.codergjw.cache.AuthStateCache;import io.github.codergjw.config.AuthConfig;import io.github.codergjw.config.AuthDefaultSource;import io.github.codergjw.entity.AuthCallback;import io.github.codergjw.entity.AuthResponse;import io.github.codergjw.entity.AuthToken;import io.github.codergjw.entity.AuthUser;import io.github.codergjw.enums.AuthResponseStatus;import io.github.codergjw.enums.AuthUserGender;import io.github.codergjw.utils.GlobalAuthUtils;import io.github.codergjw.utils.HttpUtils;import io.github.codergjw.utils.StringUtils;import io.github.codergjw.utils.UrlBuilder;import com.alibaba.fastjson.JSONObject;/** * @ClassName: AuthTaobaoRequest * @Author: 小飞 * @Date: 2023/5/13 14:41 * @Description: 淘宝授权登录请求处理类 */public class AuthTaobaoRequest extends AuthDefaultRequest {    public AuthTaobaoRequest(AuthConfig config) {        super(config, AuthDefaultSource.TAOBAO);    }    public AuthTaobaoRequest(AuthConfig config, AuthStateCache authStateCache) {        super(config, AuthDefaultSource.TAOBAO, authStateCache);    }    @Override    protected AuthToken getAccessToken(AuthCallback authCallback) {        return AuthToken.builder().accessCode(authCallback.getCode()).build();    }    /**     * 通过用户Token获取用户信息     *     * @param authToken token信息     * @return     */    @Override    protected AuthUser getUserInfo(AuthToken authToken) {        String response = doPostAuthorizationCode(authToken.getAccessCode());        JSONObject accessTokenObject = JSONObject.parseObject(response);        // 交默认类执行        this.checkResponse(accessTokenObject);        authToken = this.getAuthToken(accessTokenObject);        String nick = GlobalAuthUtils.urlDecode(accessTokenObject.getString("taobao_user_nick"));        return AuthUser.builder()                .rawUserInfo(accessTokenObject)                .uuid(StringUtils.isEmpty(authToken.getUid()) ? authToken.getOpenId() : authToken.getUid())                .username(nick)                .nickname(nick)                .gender(AuthUserGender.UNKNOWN)                .token(authToken)                .source(source.toString())                .build();    }    private AuthToken getAuthToken(JSONObject object) {        this.checkResponse(object);        return AuthToken.builder()                .accessToken(object.getString("access_token"))                .expireIn(object.getIntValue("expires_in"))                .tokenType(object.getString("token_type"))                .idToken(object.getString("id_token"))                .refreshToken(object.getString("refresh_token"))                .uid(object.getString("taobao_user_id"))                .openId(object.getString("taobao_open_uid"))                .build();    }    /**     * token 续期     *     * @param oldToken     * @return     */    @Override    public AuthResponse refresh(AuthToken oldToken) {        String tokenUrl = refreshTokenUrl(oldToken.getRefreshToken());        String response = new HttpUtils(config.getHttpConfig()).post(tokenUrl).getBody();        JSONObject accessTokenObject = JSONObject.parseObject(response);        return AuthResponse.builder()                .code(AuthResponseStatus.SUCCESS.getCode())                .data(this.getAuthToken(accessTokenObject))                .build();    }    /**     * 返回带{@code state}参数的授权url，授权回调时会带上这个{@code state}     *     * @param state state 验证授权流程的参数，可以防止csrf     * @return     */    @Override    public String authorize(String state) {        return UrlBuilder.fromBaseUrl(source.authorize())                .queryParam("response_type", "code")                .queryParam("client_id", config.getClientId())                .queryParam("redirect_uri", config.getRedirectUri())                .queryParam("view", "web")                .queryParam("state", getRealState(state))                .build();    }}